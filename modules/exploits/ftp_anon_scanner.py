import ftplib
from core.base_module import BaseModule
from rich.console import Console

class FtpAnonScanner(BaseModule):
    """Checks if an FTP server allows anonymous login."""

    def get_options(self):
        """
        Returns the options for this module.
        """
        return {
            'RHOST': ['', 'The target host IP address.'],
            'RPORT': [21, 'The target port.']
        }

    def run(self, options):
        """
        Executes the FTP anonymous login check.
        """
        rhost = options.get('RHOST')
        rport = int(options.get('RPORT'))
        console = Console()

        if not rhost:
            console.print("[!] RHOST must be set.", style="bold red")
            return

        console.print(f"[*] Checking for anonymous FTP login on {rhost}:{rport}...")

        try:
            ftp = ftplib.FTP()
            ftp.connect(rhost, rport, timeout=10)
            ftp.login('anonymous', 'anonymous')
            console.print("[bold green][+] Success! Anonymous login is enabled.[/bold green]")
            console.print(f"[*] FTP Banner: {ftp.getwelcome()}")
            ftp.quit()
        except ftplib.error_perm as e:
            console.print(f"[yellow][-] Anonymous login not allowed: {e}[/yellow]")
        except Exception as e:
            console.print(f"[!] An error occurred: {e}", style="bold red")
